name: Deployment Status Workflow

on:
  push:
    branches: [ main ]

jobs:
  pre-deployment:
    name: pre-deployment
    runs-on: ubuntu-latest
    outputs:
      previous_commit: ${{ steps.get_prev_commit.outputs.previous_commit }}
      current_commit: ${{ github.sha }}
      package_version: ${{ steps.get_version.outputs.package_version }}
      issue_number: ${{ steps.create_issue.outputs.issue_number }}
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 2  # Fetch at least 2 commits to get previous commit
      
      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20.x
          
      - name: Install dependencies
        run: npm ci
        
      - name: Run lint checks
        run: npm run lint || echo "Linting failed - continuing with deployment preparation"
        
      - name: Run tests
        run: npm test || echo "Tests failed - continuing with deployment preparation"
        
      - name: Get previous commit SHA
        id: get_prev_commit
        run: echo "previous_commit=$(git rev-parse HEAD~1)" >> "$GITHUB_OUTPUT"
        
      - name: Get package version
        id: get_version
        run: echo "package_version=$(jq -r '.version' package.json)" >> "$GITHUB_OUTPUT"
        
      - name: Create deployment tracking issue
        id: create_issue
        uses: actions/github-script@v7
        with:
          script: |
            const { data: issue } = await github.rest.issues.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: `Deployment Tracking - ${context.sha}`,
              body: `# Deployment Tracking - ${context.sha}
              
              This issue tracks the deployment process for commit ${context.sha}
              
              ## Deployment Details
              - **Previous Commit**: ${process.env.PREVIOUS_COMMIT}
              - **Current Commit**: ${context.sha}
              - **Package Version**: ${process.env.PACKAGE_VERSION}
              - **Deployment Started**: ${new Date().toISOString()}`,
              labels: ['deployment', 'in-progress']
            });
            return issue.number;
        env:
          PREVIOUS_COMMIT: ${{ steps.get_prev_commit.outputs.previous_commit }}
          PACKAGE_VERSION: ${{ steps.get_version.outputs.package_version }}
          
      - name: Post pre-deployment comment
        uses: actions/github-script@v7
        with:
          script: |
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: ${{ steps.create_issue.outputs.issue_number }},
              body: "Pre-deployment checks completed"
            });

  rollback-preparation:
    name: rollback-preparation
    runs-on: ubuntu-latest
    needs: pre-deployment
    outputs:
      rollback_artifact_name: ${{ steps.create_rollback.outputs.artifact_name }}
      rollback_checksum: ${{ steps.create_rollback.outputs.checksum }}
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 2
          
      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20.x
          
      - name: Install dependencies
        run: npm ci
          
      - name: Create rollback artifacts
        id: create_rollback
        run: |
          # Create rollback script
          cat > rollback.sh << 'EOF'
          #!/bin/bash
          set -euo pipefail

          echo "=== Rollback Script for mcpmark-cicd ==="
          echo "Rolling back from commit $1 to commit $2"
          
          # Verify we have git access
          if ! command -v git &> /dev/null; then
              echo "ERROR: git is not installed" >&2
              exit 1
          fi
          
          # Check if we're in a git repository
          if [ ! -d ".git" ]; then
              echo "ERROR: Not in a git repository" >&2
              exit 1
          fi
          
          # Stash any current changes
          echo "Stashing current changes..."
          git stash push -m "rollback-stash"
          
          # Checkout previous commit
          echo "Checking out previous commit: $2"
          git checkout "$2"
          
          # Reinstall dependencies
          echo "Reinstalling dependencies..."
          npm ci
          
          # Verify installation
          echo "Verifying installation..."
          if ! npm list &> /dev/null; then
              echo "ERROR: Dependency installation failed" >&2
              git checkout "$1"
              exit 1
          fi
          
          echo "=== Rollback completed successfully to commit $2 ==="
          echo "Deployment reverted to version: $(jq -r '.version' package.json)"
          EOF
          
          # Make script executable
          chmod +x rollback.sh
          
          # Create rollback documentation
          cat > ROLLBACK.md << 'EOF'
          # Rollback Guide for mcpmark-cicd

          ## Overview
          This guide provides step-by-step instructions to rollback from the current deployment to the previous version.

          ## Prerequisites
          1. Git installed
          2. Node.js installed (v20.x recommended)
          3. NPM or Yarn installed
          4. Proper permissions to access the repository

          ## Rollback Steps
          
          1. **Prepare your environment**
             - Ensure you're in the correct working directory
             - Backup any important files that might be overwritten
          
          2. **Download rollback package**
             - Download the rollback artifact from the GitHub Actions run
             - Extract it to your deployment directory
          
          3. **Execute rollback script**
             ```bash
             ./rollback.sh <current-commit-sha> <previous-commit-sha>
             ```
          
          4. **Verify rollback**
             - Check that the application is running properly
             - Run tests to ensure functionality is intact
             - Verify the package version matches the previous version
          
          5. **Post-rollback cleanup**
             - Remove temporary files
             - Update deployment tracking issue
             - Document the rollback reason and outcome

          ## Troubleshooting
          - If git checkout fails, verify you have the correct commit SHAs
          - If dependencies fail to install, try clearing npm cache first
          - For persistent issues, contact the DevOps team
          EOF
          
          # Create configuration backup directory
          mkdir -p rollback-backups
          cp package.json package-lock.json rollback-backups/
          
          # Create dependency verification script
          cat > verify-dependencies.sh << 'EOF'
          #!/bin/bash
          set -euo pipefail

          echo "=== Dependency Verification Script ==="
          
          # Check package.json integrity
          if ! jq . package.json > /dev/null 2>&1; then
              echo "ERROR: package.json is corrupted" >&2
              exit 1
          fi
          
          # Check package-lock.json integrity
          if ! jq . package-lock.json > /dev/null 2>&1; then
              echo "ERROR: package-lock.json is corrupted" >&2
              exit 1
          fi
          
          # Verify dependency versions match
          echo "Verifying dependency versions match lockfile..."
          npm ci --dry-run
          
          echo "=== Dependency verification completed successfully ==="
          EOF
          
          chmod +x verify-dependencies.sh
          
          # Create artifact name
          ARTIFACT_NAME="rollback-package-${{ github.sha }}"
          mkdir -p "$ARTIFACT_NAME"
          
          # Move all rollback files to artifact directory
          mv rollback.sh ROLLBACK.md verify-dependencies.sh rollback-backups/ "$ARTIFACT_NAME/"
          
          # Create checksum
          CHECKSUM=$(sha256sum "$ARTIFACT_NAME.tar.gz" | awk '{print $1}')
          
          # Create tar.gz package
          tar -czf "$ARTIFACT_NAME.tar.gz" "$ARTIFACT_NAME"
          
          # Generate checksum file
          echo "$CHECKSUM  $ARTIFACT_NAME.tar.gz" > "$ARTIFACT_NAME.sha256"
          
          # Output values for next steps
          echo "artifact_name=$ARTIFACT_NAME" >> "$GITHUB_OUTPUT"
          echo "checksum=$CHECKSUM" >> "$GITHUB_OUTPUT"
          
      - name: Upload rollback artifacts
        uses: actions/upload-artifact@v4
        with:
          name: ${{ steps.create_rollback.outputs.artifact_name }}
          path: |
            ${{ steps.create_rollback.outputs.artifact_name }}.tar.gz
            ${{ steps.create_rollback.outputs.artifact_name }}.sha256
          retention-days: 30
          
      - name: Post rollback preparation comment
        uses: actions/github-script@v7
        with:
          script: |
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: ${{ needs.pre-deployment.outputs.issue_number }},
              body: `# ðŸ”„ Rollback Plan Ready
              
              ## Deployment Details
              - Previous Commit: ${{ needs.pre-deployment.outputs.previous_commit }}
              - Current Commit: ${{ needs.pre-deployment.outputs.current_commit }}
              - Package Version: ${{ needs.pre-deployment.outputs.package_version }}
              
              ## Rollback Artifact
              - Artifact: ${{ steps.create_rollback.outputs.artifact_name }}
              - SHA256: ${{ steps.create_rollback.outputs.checksum }}
              
              ## Completed Rollback Components
              âœ… Rollback script created
              âœ… Configuration backups created
              âœ… Dependency verification script created
              âœ… Rollback documentation prepared
              âœ… Compressed artifact with checksums
              
              ## Quick Rollback Command
              \`\`\`bash
              # Download the artifact and extract it
              tar -xzf ${{ steps.create_rollback.outputs.artifact_name }}.tar.gz
              
              # Run the rollback script
              cd ${{ steps.create_rollback.outputs.artifact_name }}
              ./rollback.sh ${{ needs.pre-deployment.outputs.current_commit }} ${{ needs.pre-deployment.outputs.previous_commit }}
              \`\`\`
              
              ## Verification Status
              - Rollback script created: true
              - Configuration backup: true
              - SHA256: ${{ steps.create_rollback.outputs.checksum }}`
            });

  post-deployment:
    name: post-deployment
    runs-on: ubuntu-latest
    needs: rollback-preparation
    
    steps:
      - name: Update issue labels
        uses: actions/github-script@v7
        with:
          script: |
            // Remove in-progress label
            await github.rest.issues.removeLabel({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: ${{ needs.pre-deployment.outputs.issue_number }},
              name: 'in-progress'
            });
            
            // Add completed label
            await github.rest.issues.addLabels({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: ${{ needs.pre-deployment.outputs.issue_number }},
              labels: ['completed']
            });
            
            // Post final comment
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: ${{ needs.pre-deployment.outputs.issue_number }},
              body: `# Deployment Completed Successfully
              
              ## Deployment Summary
              - Previous Commit: ${{ needs.pre-deployment.outputs.previous_commit }}
              - Current Commit: ${{ needs.pre-deployment.outputs.current_commit }}
              - Package Version: ${{ needs.pre-deployment.outputs.package_version }}
              
              ## Rollback Information
              Rollback artifact is available for 30 days:
              - Artifact: ${{ needs.rollback-preparation.outputs.rollback_artifact_name }}
              - SHA256: ${{ needs.rollback-preparation.outputs.rollback_checksum }}
              
              Use the rollback artifacts if you need to revert this deployment.`
            });
            
            // Close the issue
            await github.rest.issues.update({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: ${{ needs.pre-deployment.outputs.issue_number }},
              state: 'closed'
            });